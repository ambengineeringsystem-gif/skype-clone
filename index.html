<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Viewer â€” Live Cam</title>
  <style>
    :root{--accent:#2b9cff;--danger:#e04b4b;--bg:#0b1220;--card:#0f1724}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff;background:var(--bg)}
    .app{position:fixed;inset:0;display:flex;flex-direction:column}
    /* full-bleed video */
    .video-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#000}
    video{width:100%;height:100%;object-fit:cover;display:block}

    /* top bar */
    .topbar{position:absolute;top:12px;left:12px;right:12px;display:flex;justify-content:space-between;align-items:center;z-index:30}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#176fc2);display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    .title{font-size:16px;font-weight:700}
    .status-pill{background:rgba(0,0,0,0.35);padding:8px 12px;border-radius:999px;font-size:13px;color:#d6e9ff}

    /* idle overlay */
    .idle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:20;text-align:center}
    .idle .text{font-size:20px;font-weight:700;color:rgba(255,255,255,0.95);background:rgba(0,0,0,0.35);padding:10px 18px;border-radius:10px}

    /* incoming call modal centered */
    .modal-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:50}
    .call-card{width:92%;max-width:420px;padding:18px;border-radius:14px;background:linear-gradient(180deg,#0f1724,#0b1220);border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 60px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:12px;align-items:center}
    .ring-anim{width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(43,156,255,0.12),rgba(24,113,194,0.08));position:relative}
    .ring-anim::after{content:'';position:absolute;inset:-10px;border-radius:50%;box-shadow:0 0 0 10px rgba(43,156,255,0.06);animation:pulse 1.6s infinite}
    @keyframes pulse{0%{transform:scale(.98);opacity:0.9}50%{transform:scale(1.08);opacity:0.45}100%{transform:scale(.98);opacity:0.9}}
    .caller-name{font-size:18px;font-weight:800}
    .caller-sub{font-size:13px;color:#b6cfff}
    .actions{display:flex;gap:14px;margin-top:6px;width:100%}
    .action-btn{flex:1;padding:12px;border-radius:12px;border:none;font-weight:800}
    .accept{background:linear-gradient(180deg,var(--accent),#176fc2);color:#fff}
    .decline{background:rgba(255,255,255,0.04);color:var(--danger);border:1px solid rgba(255,255,255,0.04)}

    /* bottom bar */
    .bottombar{position:absolute;left:12px;right:12px;bottom:18px;display:flex;justify-content:center;z-index:30}
    .controls{display:flex;gap:12px;background:rgba(0,0,0,0.35);padding:8px;border-radius:999px}
    .small-btn{width:44px;height:44px;border-radius:44px;border:none;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;color:#fff}

    /* connected toast */
    .toast{position:absolute;left:50%;top:18px;transform:translateX(-50%);z-index:40;background:rgba(0,0,0,0.5);padding:8px 14px;border-radius:999px;font-weight:700}

    @media(min-width:900px){
      .idle .text{font-size:22px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="video-wrap">
      <video id="remoteVideo" autoplay playsinline></video>

      <div class="topbar">
        <div class="brand"><div class="logo">VC</div><div class="title">Live Viewer</div></div>
        <div class="status-pill" id="statusPill">Idle</div>
      </div>

      <div class="idle" id="idleOverlay"><div class="text">No calls</div></div>

      <!-- incoming modal (centered) -->
      <div id="incomingModal" class="modal-overlay" style="display:none">
        <div class="call-card" role="dialog" aria-label="Incoming">
          <div class="ring-anim" id="ringAnim"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#2b9cff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a8 8 0 0 0 0-6"></path><path d="M4.6 9a8 8 0 0 0 0 6"></path></svg></div>
          <div class="caller-name" id="callerName">Incoming Call</div>
          <div class="caller-sub" id="callerSubtitle">Someone wants to share their webcam</div>
          <div class="actions"><button id="modalAccept" class="action-btn accept">Answer</button><button id="modalReject" class="action-btn decline">Decline</button></div>
        </div>
      </div>

      <div class="toast" id="toast" style="display:none">Connected</div>

      <div class="bottombar">
        <div class="controls">
          <button id="btnMute" class="small-btn" title="Toggle mute">ðŸ”ˆ</button>
          <button id="btnHang" class="small-btn" title="Hang up" style="display:none">âœ–</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getDatabase, ref, onChildAdded, update } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyD_5naeIoS-du5iwSlxhSCaxQnBVZ1Jn1Q",
    authDomain: "data-2-2b770.firebaseapp.com",
    databaseURL: "https://data-2-2b770-default-rtdb.firebaseio.com",
    projectId: "data-2-2b770",
    storageBucket: "data-2-2b770.firebasestorage.app",
    messagingSenderId: "560682274163",
    appId: "1:560682274163:web:1979df0d5ca13c2b784906",
    measurementId: "G-KBR7B4PMM8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const remoteVideo = document.getElementById('remoteVideo');
  const idleOverlay = document.getElementById('idleOverlay');
  const statusPill = document.getElementById('statusPill');
  const toast = document.getElementById('toast');

  const incomingModal = document.getElementById('incomingModal');
  const modalAccept = document.getElementById('modalAccept');
  const modalReject = document.getElementById('modalReject');
  const callerName = document.getElementById('callerName');
  const callerSubtitle = document.getElementById('callerSubtitle');
  const btnHang = document.getElementById('btnHang');

  let pc = null;
  const pcConfig = {iceServers:[{urls:['stun:stun.l.google.com:19302']} ] };
  let ringtoneCtx = null, ringtoneInterval = null, modalActive = false;

  function startRingtone(){
    try{
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if(!Ctx) return;
      ringtoneCtx = new Ctx();
      function playBurst(){
        const o = ringtoneCtx.createOscillator();
        const g = ringtoneCtx.createGain();
        o.type = 'sine'; o.frequency.value = 720;
        g.gain.value = 0.0001; o.connect(g); g.connect(ringtoneCtx.destination);
        const now = ringtoneCtx.currentTime; g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.08, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
        o.start(now); o.stop(now+0.65);
      }
      playBurst(); ringtoneInterval = setInterval(playBurst, 900); try{ if(navigator.vibrate) navigator.vibrate([200,120,200]); }catch(e){}
    }catch(e){ console.warn('ring failed', e); }
  }
  function stopRingtone(){ if(ringtoneInterval){ clearInterval(ringtoneInterval); ringtoneInterval=null; } if(ringtoneCtx){ try{ ringtoneCtx.close(); }catch(e){} ringtoneCtx=null; } try{ if(navigator.vibrate) navigator.vibrate(0); }catch(e){} }

  function makePeerConnection(){
    pc = new RTCPeerConnection(pcConfig);
    pc.ontrack = (e)=>{
      if(e.streams && e.streams[0]){ remoteVideo.srcObject = e.streams[0]; idleOverlay.style.display='none'; statusPill.textContent='Connected'; btnHang.style.display='inline-flex'; showToast('Connected'); }
      else { const ms = new MediaStream(); e.track && ms.addTrack(e.track); remoteVideo.srcObject = ms; idleOverlay.style.display='none'; }
    };
    pc.oniceconnectionstatechange = ()=>{
      const s = pc.iceConnectionState; console.log('ice', s); statusPill.textContent = s;
      if(s === 'disconnected' || s === 'failed' || s === 'closed'){ idleOverlay.style.display=''; statusPill.textContent='Idle'; try{ pc.close(); }catch(e){} pc=null; btnHang.style.display='none'; }
    };
  }

  function waitForIceGatheringComplete(pc){
    return new Promise((resolve)=>{
      if(pc.iceGatheringState === 'complete') return resolve();
      function check(){ if(pc.iceGatheringState === 'complete'){ pc.removeEventListener('icegatheringstatechange', check); resolve(); } }
      pc.addEventListener('icegatheringstatechange', check);
      pc.addEventListener('icecandidate', (ev)=>{ if(!ev.candidate) resolve(); }, {once:true});
    });
  }

  function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>{ toast.style.display='none'; }, 2500); }

  // listen for sessions
  const sessionsRef = ref(db, 'sessions');
  onChildAdded(sessionsRef, async (snap)=>{
    const key = snap.key; const data = snap.val(); if(!data) return;
    if((data.status === 'pending' || !data.status) && !modalActive){
      const label = data.label || data.callerName || `Request ${key.slice(0,6)}`;
      callerName.textContent = label; callerSubtitle.textContent = 'Tap Answer to view';
      // show modal immediately
      modalActive = true; incomingModal.style.display='flex'; startRingtone(); statusPill.textContent='Incoming';
      // attach accept/reject handlers once (they use session key closure)
      const accept = async ()=>{
        stopRingtone(); incomingModal.style.display='none';
        try{
          makePeerConnection();
          let offerDesc = data.offer; if(typeof offerDesc === 'string'){ try{ offerDesc = JSON.parse(offerDesc); }catch(e){ console.error('offer parse', e); } }
          if(!offerDesc || typeof offerDesc.sdp !== 'string') throw new Error('bad offer');
          await pc.setRemoteDescription(offerDesc);
          const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
          await waitForIceGatheringComplete(pc);
          const localDesc = pc.localDescription; await update(ref(db, `sessions/${key}`), { answer: JSON.stringify(localDesc), status: 'answered', viewerAt: Date.now() });
          modalActive = false; statusPill.textContent='Connected'; btnHang.style.display='inline-flex'; showToast('Call accepted');
        }catch(err){ console.error('accept failed', err); try{ await update(ref(db, `sessions/${key}`), { status: 'error' }); }catch(e){} modalActive=false; incomingModal.style.display='none'; stopRingtone(); }
      };
      const reject = async ()=>{
        stopRingtone(); incomingModal.style.display='none'; try{ await update(ref(db, `sessions/${key}`), { status: 'rejected', viewerAt: Date.now() }); }catch(e){} modalActive=false; statusPill.textContent='Idle'; showToast('Call declined'); };

      // temporary wire-up; remove previous listeners if any
      modalAccept.onclick = accept; modalReject.onclick = reject;
    }
  });

  // hang up button: just close peer locally
  btnHang.onclick = ()=>{ try{ if(pc) pc.close(); }catch(e){} pc=null; idleOverlay.style.display=''; statusPill.textContent='Idle'; btnHang.style.display='none'; showToast('Call ended'); };

  // ensure audio context can be created after user gesture
  document.addEventListener('click', ()=>{ try{ if(window.AudioContext || window.webkitAudioContext){} }catch(e){} }, {once:true});

  </script>
</body>
</html>